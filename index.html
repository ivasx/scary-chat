<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Чат з духами</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-color: #0f1419;
      --header-bg: #212d3b;
      --message-bg: #182533;
      --user-message-bg: #5288c1;
      --text-color: #ffffff;
      --secondary-text: #8aa8c8;
      --border-color: #2f3e50;
      --input-bg: #182533;
      --accent-color: #5288c1;
      --online-color: #4fb3d9;
      --shadow: rgba(0,0,0,0.3);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--bg-color);
      color: var(--text-color);
      overflow: hidden;
      background-image: var(--bg-image, none);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    .header {
      background: var(--header-bg);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 8px var(--shadow);
      position: relative;
      z-index: 100;
      border-bottom: 1px solid var(--border-color);
    }

    .chat-avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: var(--accent-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .chat-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .chat-info {
      flex: 1;
    }

    .chat-info h2 {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 2px;
      color: var(--text-color);
    }

    .chat-info .status {
      font-size: 13px;
      color: var(--secondary-text);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .online-indicator {
      width: 6px;
      height: 6px;
      background: var(--online-color);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .messages-area {
      flex: 1;
      padding: 12px 8px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      scroll-behavior: smooth;
    }

    .message {
      display: flex;
      gap: 8px;
      max-width: 80%;
      margin: 2px 0;
      position: relative;
      animation: fadeIn 0.3s ease-out;
      transition: all 0.2s;
    }

    .message.selecting {
      background: rgba(82, 136, 193, 0.1);
      border-radius: 12px;
      padding: 4px;
      margin: -2px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message.other {
      align-self: flex-start;
    }

    .message.failed {
      opacity: 0.5;
    }

    .message.failed .message-status::after {
      content: "❌";
      margin-left: 4px;
      font-size: 12px;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      background: var(--accent-color);
      overflow: hidden;
      margin-top: 2px;
    }

    .message-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .message-content {
      background: var(--message-bg);
      padding: 8px 12px;
      border-radius: 12px;
      position: relative;
      word-wrap: break-word;
      min-width: 48px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .message.user .message-content {
      background: var(--user-message-bg);
      color: white;
      border-radius: 12px 12px 4px 12px;
    }

    .message.other .message-content {
      border-radius: 12px 12px 12px 4px;
    }

    .message-sender {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 2px;
      color: var(--accent-color);
    }

    .message.user .message-sender {
      color: rgba(255,255,255,0.9);
    }

    .message-text {
      font-size: 15px;
      line-height: 1.4;
      margin-bottom: 4px;
      word-break: break-word;
    }

    .message-media {
      max-width: 100%;
      border-radius: 8px;
      margin: 4px 0;
      position: relative;
    }

    .message-media img,
    .message-media video {
      max-width: 100%;
      max-height: 400px;
      border-radius: 8px;
      display: block;
      cursor: pointer;
    }

    .message-time {
      font-size: 11px;
      color: rgba(255,255,255,0.6);
      text-align: right;
      margin-top: 2px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 4px;
    }

    .message.user .message-time {
      color: rgba(255,255,255,0.8);
    }

    .message-status {
      font-size: 12px;
    }

    .reply-to {
      background: rgba(255,255,255,0.1);
      border-left: 3px solid var(--accent-color);
      padding: 6px 8px;
      margin-bottom: 6px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .reply-to:hover {
      background: rgba(255,255,255,0.15);
    }

    .reply-to .reply-sender {
      color: var(--accent-color);
      font-weight: 500;
      margin-bottom: 2px;
    }

    .reply-to .reply-text {
      color: rgba(255,255,255,0.8);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .swipe-reply {
      position: absolute;
      left: -40px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--accent-color);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.2s;
      cursor: pointer;
      color: white;
      font-size: 14px;
    }

    .message.swiping .swipe-reply {
      opacity: 1;
      left: -50px;
    }

    .typing-indicator {
      display: none;
      padding: 8px 16px;
      color: var(--secondary-text);
      font-style: italic;
      font-size: 13px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      margin: 4px 8px;
      align-self: flex-start;
    }

    .typing-dots::after {
      content: '';
      animation: typing 1.5s infinite;
    }

    @keyframes typing {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 80% { content: '...'; }
      90%, 100% { content: ''; }
    }

    .input-area {
      padding: 12px 16px 16px;
      background: var(--bg-color);
      border-top: 1px solid var(--border-color);
    }

    .reply-preview {
      background: var(--input-bg);
      border-left: 3px solid var(--accent-color);
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 8px;
      display: none;
      position: relative;
    }

    .reply-preview .reply-sender {
      color: var(--accent-color);
      font-weight: 500;
      font-size: 13px;
      margin-bottom: 2px;
    }

    .reply-preview .reply-text {
      color: var(--secondary-text);
      font-size: 13px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .reply-close {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--secondary-text);
      cursor: pointer;
      font-size: 16px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .reply-close:hover {
      background: rgba(255,255,255,0.1);
    }

    .input-container {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      background: var(--input-bg);
      border-radius: 24px;
      padding: 8px 12px;
      position: relative;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .attachment-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: var(--secondary-text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.2s;
    }

    .attachment-btn:hover {
      background: rgba(255,255,255,0.1);
      color: var(--accent-color);
    }

    .message-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-color);
      font-size: 15px;
      padding: 6px 8px;
      resize: none;
      max-height: 120px;
      font-family: inherit;
      line-height: 1.4;
    }

    .message-input::placeholder {
      color: var(--secondary-text);
    }

    .send-button {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--accent-color);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s;
      transform: scale(0);
    }

    .send-button.visible {
      transform: scale(1);
    }

    .send-button:hover {
      background: #4a7ba7;
      transform: scale(1.1);
    }

    .send-button:disabled {
      background: #3a5068;
      cursor: not-allowed;
      transform: scale(0.9);
    }

    .attachment-menu {
      position: absolute;
      bottom: 52px;
      left: 12px;
      background: var(--header-bg);
      border-radius: 12px;
      padding: 8px;
      display: none;
      flex-direction: column;
      gap: 4px;
      box-shadow: 0 4px 20px var(--shadow);
      z-index: 10;
      border: 1px solid var(--border-color);
    }

    .attachment-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-color);
      font-size: 14px;
      transition: background 0.2s;
    }

    .attachment-option:hover {
      background: rgba(255,255,255,0.1);
    }

    .attachment-option .icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .attachment-option.photo .icon {
      background: #f093fb;
    }

    .attachment-option.video .icon {
      background: #4facfe;
    }

    .file-input {
      display: none;
    }

    .muted-notice {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(220, 53, 69, 0.9);
      color: white;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 14px;
      display: none;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .message {
        max-width: 90%;
      }
      
      .header {
        padding: 8px 12px;
      }
      
      .messages-area {
        padding: 8px 6px;
      }
    }

    /* Dark theme adjustments */
    @media (prefers-color-scheme: dark) {
      :root {
        --shadow: rgba(0,0,0,0.5);
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="chat-avatar" id="chatAvatar">👻</div>
    <div class="chat-info">
      <h2 id="chatTitle">Мертві душі</h2>
      <div class="status">
        <span id="onlineStatus">онлайн</span>
        <div class="online-indicator"></div>
      </div>
    </div>
  </div>

  <div class="chat-container">
    <div class="messages-area" id="messagesArea"></div>
    <div class="typing-indicator" id="typingIndicator">
      <span class="typing-dots">хтось друкує</span>
    </div>
    <div class="input-area">
      <div class="reply-preview" id="replyPreview">
        <div class="reply-sender" id="replySender"></div>
        <div class="reply-text" id="replyText"></div>
        <button class="reply-close" onclick="cancelReply()">×</button>
      </div>
      <div class="input-container">
        <button class="attachment-btn" onclick="toggleAttachmentMenu()">📎</button>
        <div class="attachment-menu" id="attachmentMenu">
          <label class="attachment-option photo" for="photoInput">
            <div class="icon">📷</div>
            <span>Фото</span>
          </label>
          <label class="attachment-option video" for="videoInput">
            <div class="icon">🎥</div>
            <span>Відео</span>
          </label>
        </div>
        <textarea 
          class="message-input" 
          id="messageInput" 
          placeholder="Напишіть повідомлення..."
          rows="1"
        ></textarea>
        <button class="send-button" id="sendButton">
          ➤
        </button>
      </div>
    </div>
  </div>

  <div class="muted-notice" id="mutedNotice">
    Ви заблоковані адміністратором
  </div>

  <input type="file" id="photoInput" class="file-input" accept="image/*" onchange="handleFileUpload(event, 'photo')">
  <input type="file" id="videoInput" class="file-input" accept="video/*" onchange="handleFileUpload(event, 'video')">

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBEEfn7xzGqKa1Cq9KOeeDXv836wMreFrA",
      authDomain: "scary-72f98.firebaseapp.com",
      databaseURL: "https://scary-72f98-default-rtdb.firebaseio.com",
      projectId: "scary-72f98",
      storageBucket: "scary-72f98.appspot.com",
      messagingSenderId: "450754639280",
      appId: "1:450754639280:web:5550f2cfeb4aac1f0e1275",
      measurementId: "G-6FKRD4WWHG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);
    const messagesRef = ref(db, "messages");
    const settingsRef = ref(db, "settings");
    const mutedRef = ref(db, "muted");

    const messagesArea = document.getElementById("messagesArea");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");
    const typingIndicator = document.getElementById("typingIndicator");
    const chatTitle = document.getElementById("chatTitle");
    const chatAvatar = document.getElementById("chatAvatar");
    const attachmentMenu = document.getElementById("attachmentMenu");
    const replyPreview = document.getElementById("replyPreview");
    const mutedNotice = document.getElementById("mutedNotice");

    let currentReply = null;
    let isMuted = false;
    let swipeStartX = 0;
    let swipeElement = null;

    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      
      // Show/hide send button
      if (this.value.trim()) {
        sendButton.classList.add('visible');
      } else {
        sendButton.classList.remove('visible');
      }
    });

    // Touch events for swipe to reply
    messagesArea.addEventListener('touchstart', function(e) {
      const messageElement = e.target.closest('.message');
      if (messageElement && !messageElement.classList.contains('user')) {
        swipeStartX = e.touches[0].clientX;
        swipeElement = messageElement;
      }
    });

    messagesArea.addEventListener('touchmove', function(e) {
      if (swipeElement && swipeStartX) {
        const currentX = e.touches[0].clientX;
        const diffX = currentX - swipeStartX;
        
        if (diffX > 30) {
          swipeElement.style.transform = `translateX(${Math.min(diffX, 60)}px)`;
          swipeElement.classList.add('swiping');
        }
      }
    });

    messagesArea.addEventListener('touchend', function(e) {
      if (swipeElement) {
        const currentX = e.changedTouches[0].clientX;
        const diffX = currentX - swipeStartX;
        
        if (diffX > 60) {
          // Trigger reply
          const messageId = swipeElement.getAttribute('data-message-id');
          const messageData = JSON.parse(swipeElement.getAttribute('data-message-data'));
          replyToMessage(messageId, messageData);
        }
        
        swipeElement.style.transform = '';
        swipeElement.classList.remove('swiping');
        swipeElement = null;
        swipeStartX = 0;
      }
    });

    // Close attachment menu
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.attachment-btn') && !e.target.closest('.attachment-menu')) {
        attachmentMenu.style.display = 'none';
      }
    });

    // Toggle attachment menu
    window.toggleAttachmentMenu = function() {
      attachmentMenu.style.display = attachmentMenu.style.display === 'flex' ? 'none' : 'flex';
    };

    // File upload
    window.handleFileUpload = async function(event, type) {
      const file = event.target.files[0];
      if (!file) return;

      if (isMuted) {
        showMutedNotice();
        return;
      }

      const fileRef = storageRef(storage, `${type}s/${Date.now()}_${file.name}`);
      
      try {
        const snapshot = await uploadBytes(fileRef, file);
        const downloadURL = await getDownloadURL(snapshot.ref);
        
        const messageData = {
          sender: "user",
          type: type,
          mediaUrl: downloadURL,
          timestamp: Date.now(),
          status: isMuted ? 'failed' : 'sent'
        };

        if (currentReply) {
          messageData.replyTo = currentReply;
          cancelReply();
        }

        push(messagesRef, messageData);
        attachmentMenu.style.display = 'none';
        
      } catch (error) {
        console.error('Помилка завантаження файлу:', error);
        alert('Помилка завантаження файлу');
      }
      
      event.target.value = '';
    };

    // Send message
    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;

      if (isMuted) {
        showMutedNotice();
        // Still send message but mark as failed
        const messageData = {
          sender: "user",
          text: text,
          timestamp: Date.now(),
          status: 'failed'
        };

        if (currentReply) {
          messageData.replyTo = currentReply;
          cancelReply();
        }

        push(messagesRef, messageData);
        messageInput.value = "";
        messageInput.style.height = 'auto';
        sendButton.classList.remove('visible');
        return;
      }

      const messageData = {
        sender: "user",
        text: text,
        timestamp: Date.now(),
        status: 'sent'
      };

      if (currentReply) {
        messageData.replyTo = currentReply;
        cancelReply();
      }

      push(messagesRef, messageData);

      messageInput.value = "";
      messageInput.style.height = 'auto';
      sendButton.classList.remove('visible');
    }

    // Show muted notice
    function showMutedNotice() {
      mutedNotice.style.display = 'block';
      setTimeout(() => {
        mutedNotice.style.display = 'none';
      }, 3000);
    }

    // Reply to message
    window.replyToMessage = function(messageId, messageData) {
      currentReply = { id: messageId, ...messageData };
      
      document.getElementById('replySender').textContent = 
        messageData.sender === 'user' ? 'Ви' : (messageData.character?.name || 'Невідомий');
      
      document.getElementById('replyText').textContent = 
        messageData.text || (messageData.type === 'photo' ? 'Фото' : messageData.type === 'video' ? 'Відео' : '');
      
      replyPreview.style.display = 'block';
      messageInput.focus();
    };

    // Cancel reply
    window.cancelReply = function() {
      currentReply = null;
      replyPreview.style.display = 'none';
    };

    // Scroll to message
    window.scrollToMessage = function(messageId) {
      const element = document.querySelector(`[data-message-id="${messageId}"]`);
      if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        element.classList.add('selecting');
        setTimeout(() => {
          element.classList.remove('selecting');
        }, 2000);
      }
    };

    // Event listeners
    sendButton.addEventListener("click", sendMessage);
    messageInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Listen for messages
    onValue(messagesRef, (snapshot) => {
      messagesArea.innerHTML = "";
      const data = snapshot.val();
      
      if (data) {
        const messages = Object.entries(data)
          .map(([id, msg]) => ({ id, ...msg }))
          .sort((a, b) => a.timestamp - b.timestamp);

        messages.forEach(msg => {
          const messageDiv = document.createElement("div");
          messageDiv.className = `message ${msg.sender === "user" ? "user" : "other"}${msg.status === 'failed' ? ' failed' : ''}`;
          messageDiv.setAttribute('data-message-id', msg.id);
          messageDiv.setAttribute('data-message-data', JSON.stringify(msg));
          
          const time = new Date(msg.timestamp).toLocaleTimeString('uk-UA', {
            hour: '2-digit',
            minute: '2-digit'
          });

          let mediaHtml = '';
          if (msg.type === 'photo') {
            mediaHtml = `<div class="message-media"><img src="${msg.mediaUrl}" alt="Фото" loading="lazy" onclick="window.open('${msg.mediaUrl}')"></div>`;
          } else if (msg.type === 'video') {
            mediaHtml = `<div class="message-media"><video src="${msg.mediaUrl}" controls></video></div>`;
          }

          let replyHtml = '';
          if (msg.replyTo) {
            replyHtml = `
              <div class="reply-to" onclick="scrollToMessage('${msg.replyTo.id}')">
                <div class="reply-sender">${msg.replyTo.sender === 'user' ? 'Ви' : (msg.replyTo.character?.name || 'Невідомий')}</div>
                <div class="reply-text">${msg.replyTo.text || (msg.replyTo.type === 'photo' ? 'Фото' : msg.replyTo.type === 'video' ? 'Відео' : '')}</div>
              </div>
            `;
          }

          let swipeReplyHtml = '';
          if (msg.sender !== "user") {
            swipeReplyHtml = `<div class="swipe-reply" onclick="replyToMessage('${msg.id}', ${JSON.stringify(msg).replace(/"/g, '&quot;')})">↩</div>`;
          }

          if (msg.sender === "user") {
            messageDiv.innerHTML = `
              <div class="message-avatar">👤</div>
              <div class="message-content">
                ${replyHtml}
                ${mediaHtml}
                ${msg.text ? `<div class="message-text">${msg.text}</div>` : ''}
                <div class="message-time">
                  ${time}
                  <span class="message-status">${msg.status === 'failed' ? '' : '✓'}</span>
                </div>
              </div>
            `;
          } else {
            messageDiv.innerHTML = `
              ${swipeReplyHtml}
              <div class="message-avatar" style="background: ${msg.character?.color || 'var(--accent-color)'}">
                ${msg.character?.avatar ? (msg.character.avatar.startsWith('http') ? `<img src="${msg.character.avatar}" alt="Avatar
